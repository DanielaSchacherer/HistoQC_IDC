<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Abort APi example</title>
  <style>
    .wrapper {
      width: 70%;
      max-width: 800px;
      margin: 0 auto;
    }

    video {
      max-width: 100%;
    }

    .wrapper>div {
      margin-bottom: 10px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <h1>Simple offline video player</h1>
    <div class="controls">
      <button class="download">Download video</button>
      <button class="abort hidden">Cancel download</button>
      <p class="reports"></p>
    </div>
    <div class="videoWrapper hidden">
      <p>Sintel Â© copyright Blender Foundation | <a href="http://www.sintel.org/">www.sintel.org</a>.</p>
    </div>
  </div>

  <script>
    const images = ['Slide-0002408_TI05478 4003.svs', 'TCGA-MU-A51Y.svs', '25321.svs', 'TCGA-46-6025-01Z-00-DX1.05600f09-0b48-448c-b305-cb881970fc52.svs', 'Slide-0001661_TI03267 4002.svs', '13455.svs', 'TCGA-E9-A3QA-01Z-00-DX1.9D664AF3-9ABD-4EED-B826-4C4FBFC33F3E.svs', '1762309.svs', 'OCCCF61_4645.svs', '13336.svs', '16136.svs', 'TCGA-O2-A52W-01Z-00-DX1.3D388EB0-8402-4540-9E50-7C3757FA5D83.svs', '1001530.svs', '14686.svs', '118351.svs', 'TCGA-G9-6499-01Z-00-DX1.svs', 'TCGA-DJ-A3V9-01Z-00-DX1.B7C59985-DC2A-4FDA-923B-AAAFEEC8DB77.svs', '12243.svs', 'Slide-0001439_TI01289 4007.svs', '15230.svs', 'cohortfinder_output_20240221-145537', 'TCGA-EM-A3O8-01Z-00-DX1.B164A20B-7433-420A-B947-C78CEB49B7D2.svs', 'TCGA-S5-AA26-01Z-00-DX1.svs', '23742.svs', 'TCGA-BH-A0HX-01Z-00-DX1.44EBA39E-383D-4820-915E-4E5FDA1D43DA.svs', 'TCGA-J4-A67S-01Z-00-DX1.svs', '1000984.svs', '118431.svs', '15391.svs', 'TCGA-57-1992.svs', 'TCGA-A2-A04W-01Z-00-DX1.F7E7B945-2ADC-4741-8FCE-ACEA657DB9C7.svs', 'TCGA-FK-A3SD-01Z-00-DX1.62417D7B-3565-49FD-964F-F3C0C4C01CA1.svs', '120464.svs', 'Slide-0001390_TI00705 4001.svs', 'TCGA-25-1320.svs', 'TCGA-C5-A7UH.svs', 'cohortfinder_output_20240405-184454', '16660.svs', '16491.svs', 'TCGA-BH-A0BM-01Z-00-DX1.8BD324F2-60F5-4F59-AF2D-533A5FB230BF.svs', '120777.svs', '3311002587.svs', 'Slide-0001963_TI04665 4002.svs', '20717.svs', '20660.svs', 'TCGA-DE-A4MC-01Z-00-DX1.977B0095-75D4-4D15-B912-FD2C45E8DF7D.svs', '176138.svs', '16155.svs', 'TCGA-02-0021.svs', 'Slide-0002656_TI06308 4003.svs', 'TCGA-BH-A18M-01Z-00-DX1.56E6935A-62CB-4CBE-BDCA-60DA56422CE0.svs', 'TCGA-AZ-4315-01Z-00-DX1.1a2c2771-3e59-47c3-b380-42110c545e6b.svs', 'TCGA-66-2759-01Z-00-DX1.10135ce3-22d5-4802-907d-057fe54f5554.svs', '120762.svs', 'TCGA-AM-5821-01Z-00-DX1.DB332B2D-F2A0-4499-9AAF-F9EE1B1731CF.svs', 'cohortfinder_output_20240404-190942', 'TCGA-Y6-A8TL-01Z-00-DX4.svs', '9291.svs', '121069.svs', 'TCGA-J2-8194-01Z-00-DX1.7700924D-B6AF-46A7-A7D7-B5C17A66C5F7.svs', '12748.svs', 'TCGA-E2-A158-01Z-00-DX1.994C60FE-E651-4224-95E7-4669834F2338.svs', '3511009759.svs', 'OCCCF25-4808.svs', '25038.svs', 'Slide-0001590_TI01747 4001.svs', 'TCGA-E9-A1RB-01Z-00-DX1.845074ea-43bc-4752-9dc0-fca72d2ab5de.svs', '54982.svs', 'TCGA-CH-5737-01Z-00-DX1.svs', 'Slide-0002181_TI05271 4002.svs', 'TCGA-A5-A0G5-DX1.svs', '12892.svs', 'Slide-0001473_TI01295 4006.svs', 'TCGA-LP-A5U3.svs', '54983.svs', 'TCGA-CI-6621-01A-01-BS1.d2846f26-bc31-489c-a76a-6dae8f36b293.svs', 'TCGA-BH-A0H5-01Z-00-DX1.28F24D4D-EE80-4EDA-BC30-A194E22FD61C.svs', '72012.svs', 'TCGA-AG-A00C-01A-02-BS2.05f8636d-8c83-49e0-ba22-2fe1db89b254.svs', '24624.svs', 'TCGA-AX-A06D-DX2.svs', 'TCGA-B5-A11R-DX1.svs', '1001639.svs', 'TCGA-DS-A1O9.svs', 'Slide-0001606_TI01752 4003.svs', '3369314.svs', '1001527.svs', '175775.svs', '9044.svs', 'TCGA-AY-A54L-01Z-00-DX1.BD4039B4-D732-418B-9CC9-064095A1F06F.svs', '175935.svs', 'TCGA-B5-A11P-DX1.svs', '15657.svs', 'S15-1274_PDL1.svs', 'Slide-0001870_TI04618 4004.svs', 'TCGA-EA-A3HS.svs', '118676.svs', '3311002523.svs', '1625960H.svs', 'ecce453f-c4d5-fd91-f836-14c938161269_123201.svs']

    const videoWrapper = document.querySelector('.videoWrapper');
    const downloadBtn = document.querySelector('.download');
    const abortBtn = document.querySelector('.abort');
    const reports = document.querySelector('.reports');

    let controller;
    let progressAnim;
    let animCount = 0;

    downloadBtn.addEventListener('click', fetchVideo);

    abortBtn.addEventListener('click', () => {
      controller.abort();
      console.log('Download aborted');
      downloadBtn.classList.remove('hidden');
    });

    function fetchVideo() {
      controller = new AbortController();
      const signal = controller.signal;
      downloadBtn.classList.add('hidden');
      abortBtn.classList.remove('hidden');
      reports.textContent = 'Video awaiting download...';
      images.forEach(img => {
        const fullPath = `/image/${img}/_thumb.png`;
        fetch(fullPath, { signal }).then((response) => {
          if (response.status === 200) {
            runAnimation();
            setTimeout(() => console.log('Body used: ', response.bodyUsed), 1);
            return response.blob();
          } else {
            throw new Error(response);
          }
        }).then((myBlob) => {
          console.log('Blob size: ', myBlob.size);
        }).catch((e) => {
          // abortBtn.classList.add('hidden');
          // downloadBtn.classList.remove('hidden');
          reports.textContent = 'Download error: ' + e.message;
        }).finally(() => {
          clearInterval(progressAnim);
          animCount = 0;
        });
      });

      // controller.abort();
    }

    function runAnimation() {
      progressAnim = setInterval(() => {
        switch (animCount++ & 3) {
          case 0: reports.textContent = 'Download occuring; waiting for video player to be constructed'; break;
          case 1: reports.textContent = 'Download occuring; waiting for video player to be constructed.'; break;
          case 2: reports.textContent = 'Download occuring; waiting for video player to be constructed..'; break;
          case 3: reports.textContent = 'Download occuring; waiting for video player to be constructed...'; break;
        }
      }, 300);
    }

  </script>
</body>

</html>